name: IPTV Scan & Merge Playlist

concurrency:
  group: playlist-update
  cancel-in-progress: false
  
on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # tiap 6 jam
permissions:
  contents: write

jobs:
  scan-and-merge:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install
          npx playwright install chromium

      # -------- SCANNER --------
      - name: Scan Indonesia (scanner.js)
        run: npm run scan:indonesia

      - name: Scan Premium (scanner.js)
        run: npm run scan:premium

      - name: Scan Indonesia1 (indonesia1.js)
        run: npm run scan:indonesia1

      # -------- MERGE --------
      - name: Merge playlists
        run: |
          echo "#EXTM3U" > playlist.m3u

          for f in indonesia.m3u indonesia1.m3u premium.m3u trans.m3u; do
            if [ -f "$f" ]; then
              echo "## FROM: $f" >> playlist.m3u
              grep -v '^#EXTM3U' "$f" >> playlist.m3u
              echo "" >> playlist.m3u
            else
              echo "skip $f (not found)"
            fi
          done

      # -------- COMMIT --------
      - name: Commit results
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          git add *.m3u

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "auto: update playlists" || echo "No changes"
          git pull --rebase origin main
          git push origin main
